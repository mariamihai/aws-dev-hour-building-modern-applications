# AWS Dev Hour: Building Modern Applications

Current project is based on the 2021 [Twitch series](https://pages.awscloud.com/global-traincert-twitch-dev-hour-building-modern-applications.html) hosted by Ben Newton and May Kyaw.

# The Series

## Episode 1: AWS CDK
Twitch video [here](https://www.twitch.tv/videos/892197005).

The focus of this week is creating the resources: <br>
- an S3 bucket will store the images <br>
- a Lambda function will be triggered by adding a new image <br>
- Amazon Rekognition will provide a set of labels <br>
- a DynamoDB table will contain the labels for a particular image

### AWS CDK

#### AWS CDK Commands
```
cdk init
```
- start new CDK project
- the project can either be an application (`cdk init app --language=[csharp|fsharp|java|javascript|python|typescript]`), 
a construct library (`cdk init lib --language=typescript`) or an application with some constructs (`cdk init sample-app --language=[csharp|fsharp|java|javascript|python|typescript]`)

``` 
cdk synth
```
- synthesize a CloudFormation template based on `lib/aws-dev-hour-building-modern-applications-stack.ts`
- the CloudFormation template is generated by default in the `cdk.out` folder
- cdk runs synth before each deployment automatically, this means that running this command before the `cdk deploy` one is optional


- eg, print the output in json for a particular stack: `cdk synth --json dev-stack`

```
cdk deploy
```
- deploy a stack to its environment
- if the result of this command is `Error: This stack uses assets, so the toolkit stack must be deployed to the environment (Run "cdk bootstrap
  aws://unknown-account/unknown-region")`, then [bootstrapping](https://docs.aws.amazon.com/cdk/latest/guide/bootstrapping.html) 
of the account is needed - `cdk bootstrap aws://<account>/<region>`
- [the environment](https://docs.aws.amazon.com/cdk/latest/guide/environments.html) can be set in `/bin/aws-dev-hour-building-modern-applications.ts` 
by providing the account and region (`env: { account: '<account>', region: '<region>' }`) or by using the account and region 
used by the current CLI configuration (`env: { account: process.env.CDK_DEFAULT_ACCOUNT, region: process.env.CDK_DEFAULT_REGION }`) 
- it will compare the template and tags of the current deployed stack to the template and tags that are about to be deployed 
and skips if they are identical unless `--force` is used
- if a resource fails to be created or updated, the deployment rolls back before the CLI returns. For a development stack, 
that doesn't require a consistent state at the end of an operation, `--no-rollback` or `-R` can be used
- can add parameters with `cdk deploy --parameters "Dev-Stack:TopicNameParam=parameterized" [--force]` where the parameter 
has to be used in the CDK stack:
```
new sns.Topic(this, 'TopicParameter', {
    topicName: new cdk.CfnParameter(this, 'TopicNameParam').value.toString()
});
```
- any output can be written to file by adding the `--outputs-file` (`cdk deploy --outputs-file outputs.json`), by setting 
`outputsFile` in the project's `cdk.json` file or in `~/.cdk.json`
- can hotswap deployments for faster development if the CloudFormation template has not been updated and only some resources 
where modified: `cdk deploy --hotswap [<stack-name>]`

- eg, deploy a particular stack with a particular profile: `cdk deploy <stack-name> --profile=<profile-name>`

```
cdk destroy
```
- delete a stack and the resources

### Development
AWS CLI, Node.js and AWS CDK are needed for the current project.

Initialization of the project was done by specifying the language used: `cdk init app -l typescript`

Several packages were needed: `npm install @aws-cdk/aws-s3 @aws-cdk/aws-lambda @aws-cdk/aws-lambda-event-sources @aws-cdk/aws-dynamodb @aws-cdk/aws-iam`

API Gateway is required from Episode 3: `npm install @aws-cdk/aws-apigateway`

Cognito is needed as well from Episode 4: `npm install @aws-cdk/aws-cognito`

AWS S3 Deployment package required for Episode 5: `npm install @aws-cdk/aws-s3-deployment`

AWS S3 Notifications and SQS packages are needed for episode 6: `npm install @aws-cdk/aws-s3-notifications @aws-cdk/aws-sqs`

#### Run the application
To actual use the app run `npm install`.

#### Testing
To test the current implementation, add an image in the S3 Bucket created during `cdk deploy` either in the AWS Management 
Console or by using the cli (`aws s3 cp ../<file.jpg> s3://<bucket-name>`). The Lambda function will be triggered and the 
DynamoDB table with contain the labels for the provided images.

## Episode 2: AWS Lambda & Amazon DynamoDB
Twitch video [here](https://www.twitch.tv/aws/video/901982184).

The focus of this week is:
- creating a new S3 bucket for the thumbnail images
- updating the Lambda function used with Amazon Rekognition with a Lambda layer containing the Python library for 
resizing the images and putting this image in the newly created S3 bucket
- creating a Lambda function for interacting with the user, by either returning the labels for an image or by deleting 
the image, the labels in the DynamoDB and the thumbnail image

#### Testing
Adding an image in the initial S3 bucket (`cdk-rekn-bucket`) will trigger the Lambda function and will generate the 
thumbnail image in the second S3 bucket (`cdk-rekn-bucket-resized`) and will write the labels in the DynamoDB table 
(`ImageLabels`).

In the Lambda Management Console test the service function by providing the `getLabels` action:
```
{
  "action": "getLabels",
  "key": "<image-name>"
}
```
A JSON containing the labels should be returned:
```
{
  "image": "<image-name>",
  "object1": "<label-1>",
  "object2": "<label-2>"
}
```

The `deleteImage` action can be tested as well from the Management Console:
```
{
  "action": "deleteImage",
  "key": "<image-name>"
}
```
And the result got is `"Delete request successfully processed"` and the images are removed from both S3 buckets and the 
entry in the DynamoDb table is deleted as well.

## Episode 3: Amazon API Gateway
Twitch video [here](https://www.twitch.tv/videos/910524542).

The week focuses on adding a REST Api Gateway and adding integration with the service Lambda function.

The API Gateway package is needed (`npm install @aws-cdk/aws-apigateway`).

The stack was updated with an API Gateway REST API, Lambda integration and resources on `/images` (GET and DELETE). 
Getting all labels for an image will result in a call like this: `https://<GUID>.execute-api.<REGION>.amazonaws.com/<STAGE>/images?action=getLabels&key=<image-name.jpg>`

## Episode 4: AWS IAM & Amazon Cognito
Twitch video [here](https://www.twitch.tv/aws/video/919646743).

The week focuses on integrating AWS Cognito.

Add Cognito package: `npm install @aws-cdk/aws-cognito`.

The stack was updated with a user pool and authorizer for API Gateway, then integrates an identity pool with specific role 
containing policies for accessing own S3 stored images.

## Episode 5: Amazon S3
Twitch video [here](https://www.twitch.tv/aws/video/929175626).

The focus of current's week is S3 in the context of hosting a static website and integrating it with API Gateway and 
the S3 buckets used for storing the images and thumbnail images.

AWS S3 Deployment package required for this episode: `npm install @aws-cdk/aws-s3-deployment`

Build the assets for the front end project with `npm run build` and put the files in the `/public` folder. The Frontend 
GitHub project can be found [here](https://github.com/aws-samples/aws-dev-hour-frontend).

The site is served from the website bucket. To be able to upload, retrieve or delete images, CORS policies need to be 
set on the image buckets. This is done with `addCorsRule`.

## Episode 6: Amazon SQS
Twitch video [here](https://www.twitch.tv/videos/938129601).

The current episode focuses on scaling and decoupling the imageBucket from rekognitionlambda.

Next packages are needed for current episode: `npm install @aws-cdk/aws-s3-notifications @aws-cdk/aws-sqs`

AWS S3 Notifications is used to notify SQS when an image is uploaded to the S3 imageBucket. The notifications 
will be delivered at least once, in a few seconds or more than a minute.

Lambda polls up to 10 messages at once from the SQS queue. A batch window can be configured to buffer records 
for up to 5 minutes.

## Episode 7: Deployment Pipeline


# Resources
AWS Dev Hour Building Modern Application [page](https://pages.awscloud.com/global-traincert-twitch-dev-hour-building-modern-applications.html) with resources.

[Backend](https://github.com/aws-samples/aws-dev-hour-backend) GitHub project.

[Frontend](https://github.com/aws-samples/aws-dev-hour-frontend) GitHub project.